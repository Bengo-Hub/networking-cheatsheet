# Expert Level Advanced Topics

**This section is part of the [Networking Principles Guide](../Networking-Principles.md)**

---

## Expert Level Advanced Topics

### 3.1 Advanced Routing Protocols

**OSPF Advanced Features:**

- **Area Types**:
  - Standard Area: Connects to area 0 (backbone)
  - Backbone Area (Area 0): Central area, all other areas connect to it
  - Stub Area: No external routes, default route advertised
  - Totally Stubby Area: No external or inter-area routes
  - NSSA (Not-So-Stubby Area): Allows ASBR within area
  - Totally NSSA: Combination of totally stubby and NSSA

- **LSA Types**:
  - Type 1: Router LSA (within area)
  - Type 2: Network LSA (within area)
  - Type 3: Summary LSA (inter-area)
  - Type 4: ASBR Summary LSA
  - Type 5: External LSA (from ASBR)
  - Type 7: NSSA External LSA

**Detailed OSPF LSA Types (RFC 2328):**

**Type 1 - Router LSA:**
- Generated by every OSPF router
- Flooded within area only
- Describes router's interfaces and costs
- Contains: Router ID, links to neighbors, link types (stub, transit, P2P)
- Example: Router announces its connected networks

**Type 2 - Network LSA:**
- Generated by Designated Router (DR) on multi-access networks
- Flooded within area only
- Describes all routers connected to network segment
- Contains: Network mask, connected router IDs
- Example: Ethernet segment with multiple routers

**Type 3 - Summary LSA:**
- Generated by Area Border Router (ABR)
- Flooded between areas (not into stub areas)
- Advertises networks from other areas
- Contains: Network address, subnet mask, metric
- Example: ABR advertises Area 1 networks into Area 0

**Type 4 - ASBR Summary LSA:**
- Generated by ABR
- Points to ASBR (Autonomous System Boundary Router)
- Contains: ASBR router ID, metric to ASBR
- Example: ABR tells other areas where to find ASBR

**Type 5 - External LSA:**
- Generated by ASBR
- Flooded throughout entire OSPF domain (except stub areas)
- Advertises external routes (from other routing protocols or static)
- Contains: External network, subnet mask, metric type (E1/E2), metric
- E1: External metric + internal OSPF cost
- E2: External metric only (default)
- Example: ASBR redistributes BGP routes into OSPF

**Type 7 - NSSA External LSA:**
- Generated by ASBR in NSSA area
- Similar to Type 5 but only in NSSA
- ABR converts Type 7 to Type 5 when flooding to other areas
- Example: External routes in NSSA area

**OSPF Area Type Details:**

**Standard Area:**
- Default area type
- Receives all LSA types (1, 2, 3, 4, 5)
- Can contain ASBR
- Connects to Area 0

**Stub Area:**
- Blocks Type 5 (External) LSAs
- ABR generates default route (0.0.0.0/0)
- Reduces LSA database size
- Cannot contain ASBR
- Configuration: `area 1 stub`

**Totally Stubby Area:**
- Blocks Type 3, 4, and 5 LSAs
- Only receives Type 1 and 2 LSAs + default route
- Maximum reduction in LSAs
- Cannot contain ASBR
- Configuration: `area 1 stub no-summary` (Cisco)

**NSSA (Not-So-Stubby Area):**
- Similar to stub but allows Type 7 LSAs
- Can contain ASBR (unlike stub area)
- ABR converts Type 7 to Type 5
- Configuration: `area 1 nssa`

**Totally NSSA:**
- Combination of totally stubby and NSSA
- Blocks Type 3, 4, 5 LSAs (but allows Type 7)
- Configuration: `area 1 nssa no-summary` (Cisco)

**OSPF Configuration Examples:**

**Basic OSPF Configuration (Cisco):**

```cisco
! Enable OSPF process
router ospf 1
  router-id 1.1.1.1
  
! Enable on interfaces
interface GigabitEthernet0/0
  ip address 192.168.1.1 255.255.255.0
  ip ospf 1 area 0
  
! OR enable using network command
router ospf 1
  network 192.168.1.0 0.0.0.255 area 0
  network 10.0.0.0 0.0.0.255 area 1
```

**Stub Area Configuration:**

```cisco
! ABR Configuration
router ospf 1
  router-id 1.1.1.1
  network 10.0.0.0 0.0.0.255 area 0
  network 192.168.1.0 0.0.0.255 area 1
  area 1 stub                        ! Configure as stub
  
! Internal Router in Stub Area
router ospf 1
  router-id 2.2.2.2
  network 192.168.1.0 0.0.0.255 area 1
  area 1 stub                        ! Must match ABR
```

**NSSA Configuration:**

```cisco
! ABR Configuration
router ospf 1
  area 2 nssa
  
! ASBR in NSSA
router ospf 1
  area 2 nssa
  redistribute static subnets        ! Redistribute into NSSA
```

**OSPF Route Summarization:**

```cisco
! Summarize at ABR (inter-area)
router ospf 1
  area 1 range 10.0.0.0 255.0.0.0    ! Summarize Area 1 networks
  
! Summarize at ASBR (external)
router ospf 1
  summary-address 172.16.0.0 255.255.0.0
```

**OSPF Verification Commands:**

```cisco
show ip ospf                           ! OSPF process information
show ip ospf neighbor                  ! OSPF neighbors
show ip ospf neighbor detail          ! Detailed neighbor info
show ip ospf database                  ! LSA database
show ip ospf database router          ! Type 1 LSAs
show ip ospf database network         ! Type 2 LSAs
show ip ospf database summary         ! Type 3 LSAs
show ip ospf database asbr-summary    ! Type 4 LSAs
show ip ospf database external        ! Type 5 LSAs
show ip ospf database nssa-external   ! Type 7 LSAs
show ip route ospf                    ! OSPF routes
show ip ospf interface                ! Interface OSPF info
```

**OSPF Troubleshooting:**

```cisco
debug ip ospf adj                      ! Debug adjacencies
debug ip ospf events                   ! Debug OSPF events
debug ip ospf packet                   ! Debug OSPF packets

! Common Issues:
! - Mismatched area IDs
! - Mismatched network types
! - Authentication mismatches
! - MTU mismatches
! - Duplicate router IDs
```

- **OSPFv3 (IPv6)**:
  - Link-local addresses for adjacencies
  - Multiple instances per interface
  - Address-family separation
  - For IPv6 configuration examples, see [IPv6 Workshop Guide](../docs/IPv6-Workshop-Guide.md)

**BGP Advanced Topics:**

**BGP Path Attributes (RFC 4271):**

Path attributes control BGP route selection and policy. They are classified by several characteristics:

**Well-Known Mandatory (Must be present and recognized):**
- **ORIGIN**: Indicates how route was injected into BGP
  - IGP (i): Originated via network statement
  - EGP (e): Learned via EGP (deprecated)
  - Incomplete (?): Redistributed from other protocol
  - Impact: Lower is better (IGP < EGP < Incomplete)

- **AS_PATH**: List of AS numbers traversed
  - eBGP: Prepends own AS when advertising externally
  - iBGP: Does not modify AS_PATH
  - Loop prevention: Drop if own AS in path
  - Impact: Shorter is better

- **NEXT_HOP**: IP address of next-hop router
  - eBGP: Next-hop is neighbor's IP
  - iBGP: Next-hop unchanged (by default)
  - Must be reachable via IGP

**Well-Known Discretionary (Must be recognized, optional to include):**
- **LOCAL_PREF**: Preference for exit point (iBGP only)
  - Range: 0-4294967295
  - Higher is better (default: 100)
  - Only compared for routes from same AS
  - Configuration: `bgp default local-preference 200`

- **ATOMIC_AGGREGATE**: Indicates route was aggregated
  - Warning that path information was lost

**Optional Transitive (May not be recognized, passed along):**
- **COMMUNITY**: Tags routes for policy application
  - Format: ASN:Value (e.g., 65000:100)
  - Well-known: NO_EXPORT, NO_ADVERTISE, LOCAL_AS
  - Custom communities for traffic engineering

- **AGGREGATOR**: AS and router ID that created aggregate

**Optional Non-Transitive (Dropped if not recognized):**
- **MED (Multi-Exit Discriminator)**: Hint to external AS about preferred path
  - Lower is better (default: 0)
  - Only compared for routes from same AS
  - Configuration: `set metric 50`

**BGP Route Selection Process (RFC 4271):**

BGP compares routes sequentially using these criteria:

```
1. WEIGHT (Cisco proprietary, highest wins)
   - Local to router, not advertised
   - Default: 0 for learned, 32768 for locally originated
   - Set with: neighbor 1.1.1.1 weight 100

2. LOCAL_PREF (highest wins)
   - Only compared for routes from same AS
   - Set with: bgp default local-preference 200
   - Or: set local-preference 200 (route-map)

3. Locally Originated (prefer locally originated)
   - Routes from network/aggregate/redistribute statements

4. AS_PATH (shortest wins)
   - Prefer shorter AS_PATH
   - Can prepend: set as-path prepend 65000 65000

5. ORIGIN (IGP < EGP < Incomplete)
   - i < e < ?

6. MED (lowest wins)
   - Only compared if from same AS
   - Set with: set metric 50
   - Can compare across ASes with: bgp always-compare-med

7. eBGP vs iBGP (prefer eBGP)
   - eBGP paths preferred over iBGP

8. IGP Metric (lowest wins)
   - Best IGP cost to NEXT_HOP

9. Oldest Route (eBGP only, prefer oldest)
   - Router that received route first

10. Router ID (lowest wins)
    - Lowest BGP router ID

11. Cluster List (shortest wins)
    - Route reflector cluster IDs

12. Neighbor IP (lowest wins)
    - Lowest neighbor IP address
```

**BGP Configuration Examples:**

**Basic BGP Configuration (Cisco):**

```cisco
! Configure BGP process
router bgp 65000
  router-id 1.1.1.1
  bgp log-neighbor-changes

! eBGP Peer
  neighbor 2.2.2.2 remote-as 65001
  neighbor 2.2.2.2 update-source Loopback0
  
! iBGP Peer
  neighbor 3.3.3.3 remote-as 65000
  neighbor 3.3.3.3 update-source Loopback0
  
! Advertise networks
  network 192.168.1.0 mask 255.255.255.0
```

**BGP Route Manipulation:**

```cisco
! Route-map for inbound policy
route-map INBOUND-POLICY permit 10
  set local-preference 200
  set community 65000:100

! Route-map for outbound policy
route-map OUTBOUND-POLICY permit 10
  set metric 50
  set as-path prepend 65000 65000

! Apply route-maps
router bgp 65000
  neighbor 2.2.2.2 route-map INBOUND-POLICY in
  neighbor 2.2.2.2 route-map OUTBOUND-POLICY out
```

**BGP Communities:**

```cisco
! Set community
route-map SET-COMMUNITY permit 10
  set community 65000:100 65000:200 additive

! Match community
ip community-list 1 permit 65000:100
route-map FILTER permit 10
  match community 1

! Remove community
route-map REMOVE-COMMUNITY permit 10
  set community none
```

**BGP Route Reflector Configuration:**

```cisco
! Configure as Route Reflector
router bgp 65000
  neighbor 3.3.3.3 remote-as 65000
  neighbor 3.3.3.3 route-reflector-client
  
! Cluster ID (for redundancy)
  bgp cluster-id 1.1.1.1
```

**BGP Verification Commands:**

```cisco
show ip bgp                              ! BGP table
show ip bgp summary                      ! BGP summary
show ip bgp neighbors                    ! BGP neighbors
show ip bgp neighbors 2.2.2.2           ! Specific neighbor
show ip bgp 192.168.1.0                 ! Specific route
show ip bgp community                   ! Routes by community
show ip bgp regexp ^65000               ! Routes matching regex
show ip bgp paths                        ! AS path information
show ip bgp peer-group                  ! Peer groups
debug ip bgp updates                    ! Debug BGP updates
debug ip bgp events                     ! Debug BGP events
```

**BGP Communities Reference:**

**Well-Known Communities:**
- **NO_EXPORT (0xFFFFFF01)**: Don't export to eBGP peers
- **NO_ADVERTISE (0xFFFFFF02)**: Don't advertise to any peer
- **LOCAL_AS (0xFFFFFF03)**: Don't export outside local AS (confederation)

**Common Community Practices:**
- **ASN:100**: High preference
- **ASN:200**: Medium preference
- **ASN:300**: Low preference
- **ASN:666**: Blackhole route

**BGP Troubleshooting:**

```cisco
! Verify neighbor states
! - Idle: Initial state, connection attempt
! - Connect: TCP connection established
! - Active: Connection failed, retrying
! - OpenSent: BGP OPEN sent
! - OpenConfirm: OPEN acknowledged
! - Established: BGP session established

! Common Issues:
! - TCP connectivity (port 179)
! - ASN mismatch
! - Authentication failure
! - Router ID conflict
! - BGP updates not being received/sent

debug ip bgp updates                    ! See update messages
show ip bgp neighbors 2.2.2.2 received-routes    ! Received routes
show ip bgp neighbors 2.2.2.2 advertised-routes  ! Advertised routes
```

- **Route Reflectors and Confederations**:
  - **Route Reflectors**: Reduces full mesh requirement for iBGP
    - Client/Non-client relationships
    - Cluster ID for loop prevention
  - **Confederations**: Divides AS into sub-ASes
    - External and internal confederation peers

- **BGP Communities**:
  - Tags applied to routes for policy control
  - Well-known communities: NO_EXPORT, NO_ADVERTISE, LOCAL_AS
  - Custom communities for traffic engineering

- **Multihoming Strategies**:
  - Provider-dependent: Single or multiple ISPs
  - Provider-independent: Own ASN and IP space
  - Load balancing and redundancy considerations

### 3.2 MPLS (Multiprotocol Label Switching)

**MPLS Fundamentals (RFC 3031, RFC 3032):**

- **Purpose**: Fast packet forwarding using labels instead of IP lookup
- **Components**:
  - **Label Edge Router (LER)**: Adds/removes labels (Ingress/Egress)
  - **Label Switch Router (LSR)**: Forwards based on labels
  - **Label Distribution Protocol (LDP)**: Distributes labels

**MPLS Label Structure:**

MPLS uses a 32-bit label inserted between Layer 2 and Layer 3 headers:

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                Label                  |  TC |S|       TTL     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

- Label: 20 bits (0-1048575)
  - 0-15: Reserved (0 = IPv4 Explicit NULL, 3 = IPv4 Implicit NULL)
  - 16-1048575: Normal label range

- TC (Traffic Class): 3 bits (QoS marking, replaces EXP field)
- S (Bottom of Stack): 1 bit (1 = last label in stack)
- TTL (Time To Live): 8 bits (decremented at each hop)
```

**MPLS Forwarding Operations:**

1. **Push (Impose)**: Add label to packet (Ingress LER)
2. **Swap**: Replace label with new label (Core LSR)
3. **Pop (Remove)**: Remove label (Egress LER)
   - PHP (Penultimate Hop Popping): Egress LER removes label before final hop

**MPLS Label Distribution:**

**LDP (Label Distribution Protocol) - RFC 5036:**
- Automatically distributes labels for IGP routes
- Uses TCP port 646 for session establishment
- Uses UDP port 646 for discovery (Hello messages)
- Four LDP messages:
  - **Discovery**: Hello messages (multicast to 224.0.0.2)
  - **Session**: TCP session establishment
  - **Advertisement**: Label mapping messages
  - **Notification**: Error messages

**MPLS Packet Flow:**

```
1. Ingress LER receives IP packet
2. LER performs FEC (Forwarding Equivalence Class) lookup
3. LER pushes label onto packet
4. Core LSRs swap labels (label lookup → swap → forward)
5. Egress LER pops label and forwards as IP packet
```

**MPLS Applications:**

1. **MPLS VPN (L3VPN)**:
   - Provider maintains separate routing tables (VRF) per customer
   - BGP distributes VPN routes
   - Label stack: Outer (transport) + Inner (VPN)
   - Full mesh connectivity with route reflectors

2. **MPLS Traffic Engineering (TE)**:
   - Explicit paths for traffic
   - RSVP-TE for label distribution
   - Constraint-based routing
   - Fast Reroute (FRR) for protection

3. **MPLS L2VPN**:
   - Layer 2 service emulation
   - Types: VPWS (Virtual Private Wire Service), VPLS (Virtual Private LAN Service)
   - Transparent Layer 2 connectivity

4. **Segment Routing (SR)**:
   - Source-routed tunnels
   - No signaling protocol needed
   - IPv6 extension (SRv6)
   - Simplified operations

**MPLS Advantages:**

- Fast forwarding (label swap vs IP lookup)
- Traffic engineering capabilities
- VPN services
- Scalability
- Unified infrastructure

### 3.3 Software-Defined Networking (SDN)

**SDN Architecture:**

- **Separation of Control and Data Planes**:
  - Control Plane: Routing decisions, policy
  - Data Plane: Packet forwarding
  - Centralized control, distributed forwarding

- **Components**:
  - **SDN Controller**: Centralized control logic
  - **Southbound APIs**: Communication with switches (OpenFlow)
  - **Northbound APIs**: Applications and services
  - **Network Operating System (NOS)**: Abstraction layer

**SDN Benefits:**

- Centralized management and control
- Programmability and automation
- Vendor independence
- Rapid innovation and deployment
- Improved resource utilization

**SDN Controllers:**

- OpenDaylight
- ONOS (Open Network Operating System)
- Cisco ACI
- VMware NSX
- Juniper Contrail

**OpenFlow Protocol:**

- Communication protocol between controller and switches
- Flow tables with match/action rules
- Versions: 1.0 through 1.5, evolving

**SDN Use Cases:**

- Data center networks
- WAN optimization (SD-WAN)
- Network virtualization
- Traffic engineering
- Security policy enforcement

### 3.4 Network Function Virtualization (NFV)

**NFV Concepts:**

- Decouples network functions from dedicated hardware
- Runs network functions as software on commodity hardware
- Virtualized network appliances (vFirewall, vRouter, vLoad Balancer)

**NFV Architecture:**

- **Virtualized Network Functions (VNFs)**: Software implementations of network functions
- **NFV Infrastructure (NFVI)**: Compute, storage, network resources
- **Management and Orchestration (MANO)**:
  - NFV Orchestrator (NFVO)
  - VNF Manager (VNFM)
  - Virtual Infrastructure Manager (VIM)

**NFV Benefits:**

- Reduced CAPEX and OPEX
- Faster service deployment
- Scalability and elasticity
- Vendor independence
- Innovation acceleration

**NFV vs SDN:**

- **NFV**: Virtualizes network functions
- **SDN**: Separates control and data planes
- Complementary technologies

### 3.5 Network Virtualization

**VRF (Virtual Routing and Forwarding):**

- Multiple routing tables on single router
- Isolation between routing instances
- Used in MPLS VPNs and network segmentation
- Separate routing table per VRF

**VXLAN (Virtual eXtensible LAN):**

- Layer 2 overlay over Layer 3 network
- 24-bit VNI (VXLAN Network Identifier)
- UDP encapsulation (port 4789)
- MAC-in-UDP tunneling
- Used in data centers and cloud environments

**EVPN (Ethernet VPN):**

- BGP-based control plane for Layer 2/3 VPNs
- Combines benefits of L2 and L3 VPNs
- Supports multihoming and load balancing
- Uses MPLS or VXLAN encapsulation

**Overlay Networks:**

- Logical network built on top of physical network
- Decouples logical topology from physical topology
- Examples: VXLAN, NVGRE, STT
- Enables network virtualization and multi-tenancy

---

## References and Further Reading

### RFC Documents

**OSPF:**
- **RFC 2328**: OSPF Version 2 (Current standard)
- **RFC 5340**: OSPF for IPv6 (OSPFv3)
- **RFC 3101**: OSPF Not-So-Stubby Area (NSSA) Option
- **RFC 1583**: OSPF Version 2 (Obsolete, superseded by 2328)

**BGP:**
- **RFC 4271**: Border Gateway Protocol 4 (BGP-4)
- **RFC 4760**: Multiprotocol Extensions for BGP-4 (MP-BGP)
- **RFC 1997**: BGP Communities Attribute
- **RFC 4456**: BGP Route Reflection
- **RFC 5065**: Autonomous System Confederations for BGP

**MPLS:**
- **RFC 3031**: Multiprotocol Label Switching Architecture
- **RFC 3032**: MPLS Label Stack Encoding
- **RFC 5036**: LDP Specification
- **RFC 4364**: BGP/MPLS IP Virtual Private Networks (L3VPN)
- **RFC 3209**: RSVP-TE: Extensions to RSVP for LSP Tunnels

**SDN/NFV:**
- **RFC 7149**: Software-Defined Networking: A Perspective from within a Service Provider Environment
- **OpenFlow Specification**: https://opennetworking.org/wp-content/uploads/2013/04/openflow-spec-v1.3.0.pdf

### Trusted Online Resources

- **IETF RFC Repository**: https://www.ietf.org/standards/rfcs/
- **Cisco Documentation**: https://www.cisco.com/c/en/us/support/index.html
  - OSPF Configuration Guides
  - BGP Configuration Guides
  - MPLS Configuration Guides
- **Juniper Documentation**: https://www.juniper.net/documentation/
- **Network Encyclopedia**: Various networking concepts and protocols
- **Packet Life Cheat Sheets**: http://packetlife.net/library/cheat-sheets/
- **NetworkLessons**: Practical networking tutorials and examples

### Configuration Guides

- For router configuration commands, see: [Configuration Cheatsheet](../docs/Configuration-Cheatsheet.md)
- For IS-IS configuration examples, see: [IPv6 Workshop Guide](../docs/IPv6-Workshop-Guide.md)

---